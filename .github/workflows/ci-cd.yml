name: Simple Blue/Green Test

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version
        
    - name: Start Services
      run: |
        BLUE_IMAGE=node:18-alpine GREEN_IMAGE=node:18-alpine docker-compose up -d
        echo "Waiting for services to start..."
        sleep 30
        
    - name: Check Service Status
      run: |
        docker-compose ps
        echo "Services should be starting up..."
        
    - name: Basic Connectivity Test
      run: |
        sudo apt-get install -y curl
        echo "Testing basic connectivity..."
        
        # Test if containers are running
        if docker-compose ps | grep -q "Up"; then
          echo "✅ Docker services are running"
        else
          echo "❌ Docker services failed to start"
          exit 1
        fi
        
        # Test direct app access (may fail if apps are still starting)
        echo "Testing application access..."
        timeout 10s bash -c 'until curl -s http://localhost:8081/healthz >/dev/null; do sleep 2; echo "Waiting for Blue..."; done' || echo "Blue not ready yet"
        timeout 10s bash -c 'until curl -s http://localhost:8082/healthz >/dev/null; do sleep 2; echo "Waiting for Green..."; done' || echo "Green not ready yet"
        
    - name: Check Logs
      if: always()
      run: |
        echo "=== Service Logs ==="
        docker-compose logs --tail=50
        
    - name: Cleanup
      if: always()
      run: docker-compose down -v